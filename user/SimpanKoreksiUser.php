<?php
require_once '../auth.php';
include "../koneksi.php";

/* ================== FUNGSI SANITASI ================== */
function bersih($data)
{
    return htmlspecialchars($data, ENT_QUOTES, 'UTF-8');
}

/* ================== AMBIL DATA FORM ================== */
$id = bersih($_POST['id'] ?? '');
$username = bersih($_POST['username'] ?? '');
$nama = bersih($_POST['nama'] ?? '');
$password = bersih($_POST['password'] ?? '');
$foto_lama = $_POST['foto_lama'] ?? '';

if (empty($id)) {
    header('Location: TampilUser.php?error=id');
    exit;
}

/* ================== FOTO ================== */
$xfoto = $foto_lama;

// Jika user upload foto baru
if (!empty($_FILES['foto']['name'])) {
    $namaFile = $_FILES['foto']['name'];
    $tmpFile = $_FILES['foto']['tmp_name'];
    $ext = strtolower(pathinfo($namaFile, PATHINFO_EXTENSION));
    $allowedExt = ['jpg', 'jpeg', 'png', 'gif'];

    if (in_array($ext, $allowedExt)) {
        $namaFotoBaru = uniqid("foto_") . "." . $ext;
        move_uploaded_file($tmpFile, "uploads/" . $namaFotoBaru);
        $xfoto = $namaFotoBaru;
    }
}

/* ================== UPDATE DATABASE ================== */
if (!empty($password)) {
    // Update dengan password baru
    $hashed_password = password_hash($password, PASSWORD_BCRYPT);
    $sql = "UPDATE users SET username=?, nama=?, password=?, foto=? WHERE id=?";
    $stmt = $koneksi->prepare($sql);
    $stmt->bind_param("ssssi", $username, $nama, $hashed_password, $xfoto, $id);
} else {
    // Update tanpa password
    $sql = "UPDATE users SET username=?, nama=?, foto=? WHERE id=?";
    $stmt = $koneksi->prepare($sql);
    $stmt->bind_param("sssi", $username, $nama, $xfoto, $id);
}

if ($stmt->execute()) {
    header('Location: TampilUser.php');
} else {
    error_log("Error update user: " . mysqli_error($koneksi));
    header('Location: TampilUser.php?error=1');
}

$stmt->close();
$koneksi->close();
exit;
?>